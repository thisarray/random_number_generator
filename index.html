<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charts of Random Numbers Over the Past Month</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
google.charts.load('current', {packages: ['corechart', 'table']});
google.charts.setOnLoadCallback(fetchData);

function fetchData() {
  if (typeof google === "undefined") {
    return;
  }
  fetch('https://thisarray.github.io/random_number_generator/business.json')
    .then(response => response.json())
    .then(data => drawCharts(data));
}

/*
 * Return an ISO date string (YYYY-MM-DD) from date containing only the year, month, and date.
 */
function date_to_iso(date) {
 return `${ date.getFullYear() }-${ (date.getMonth() + 1).toFixed().padStart(2, '0') }-${ date.getDate().toFixed().padStart(2, '0') }`;
}

/*
 * Return an array of Date objects starting from a month ago to today, inclusive.
 */
function getLastMonth(today) {
  let dates = [],
      year = today.getFullYear(),
      month = today.getMonth() - 1,
      date = today.getDate();
  if (month < 0) {
    year--;
    month = 11;
  }

  // Add the dates from the previous month
  for (let i = date; i < 32; i++) {
    let d = new Date(year, month, i);
    if ((d.getFullYear() === year) &&
        (d.getMonth() === month) &&
        (d.getDate() === i)) {
      dates.push(d);
    }
  }

  // Add the dates from the current month including today
  month++;
  if (month > 11) {
    month = 0;
    year++;
  }
  for (let i = 1; i <= date; i++) {
    let d = new Date(year, month, i);
    if ((d.getFullYear() === year) &&
        (d.getMonth() === month) &&
        (d.getDate() === i)) {
      dates.push(d);
    }
  }

  return dates;
}

/*
 * Draw the chart for the dates in dates.
 */
function drawLastMonth(elementID, jsonData, dates) {
  const element = document.querySelector(elementID);

  let data = new google.visualization.DataTable(),
      chart = new google.visualization.LineChart(element),
      options = {
        legend: { position: 'bottom' }
      },
      isoDate, row;

  data.addColumn('date', 'Date');
  data.addColumn('number', 'Dow Jones Industrial Average');
  data.addColumn('number', 'NASDAQ Composite');
  data.addColumn('number', 'S&P 500');
  for (let date of dates) {
    isoDate = date_to_iso(date);
    if (isoDate in jsonData) {
      row = [date];
      for (let [i, scale] of [['^DJI', 8], ['^IXIC', 3], ['^GSPC', 1]]) {
        row.push({v: parseFloat(jsonData[isoDate][i].replaceAll(',', '')) / scale, f: jsonData[isoDate][i]});
      }
      data.addRow(row);
    }
  }

  chart.draw(data, options);
}

/*
 * Draw a histogram of the counts in dataArray.
 */
function drawHistogram(elementID, dataArray) {
  const element = document.querySelector(elementID);

  let length = dataArray.length,
      data = new google.visualization.DataTable(),
      chart = new google.visualization.ColumnChart(element),
      options = {
        bar: {groupWidth: '96%'},
        colors: ['green'],
        hAxis: {title: 'Value'},
        legend: {position: 'none'},
        vAxis: {title: 'Count'}
      };

  data.addColumn('number', 'Value');
  data.addColumn('number', 'Count');
  for (let i = 0; i < length; i++) {
    data.addRow([i, dataArray[i]]);
  }
  chart.draw(data, options);
}

/*
 * Populate the charts with data from jsonData.
 */
function drawCharts(jsonData) {
  let today = new Date(),
      dates = getLastMonth(today),
      tens = (new Array(10)).fill(0),
      ones = (new Array(10)).fill(0),
      tenths = (new Array(10)).fill(0),
      hundredths = (new Array(10)).fill(0),
      index;

  drawLastMonth('#chart', jsonData, dates);

  for (let date of dates) {
    isoDate = date_to_iso(date);
    if (isoDate in jsonData) {
      for (let i of ['^DJI', '^IXIC', '^GSPC']) {
        index = jsonData[isoDate][i].indexOf('.');
        if (index < 2) {
          continue;
        }
        if (jsonData[isoDate][i].length <= (index + 2)) {
          continue;
        }
        tens[parseInt(jsonData[isoDate][i].charAt(index - 2), 10)] += 1;
        ones[parseInt(jsonData[isoDate][i].charAt(index - 1), 10)] += 1;
        tenths[parseInt(jsonData[isoDate][i].charAt(index + 1), 10)] += 1;
        hundredths[parseInt(jsonData[isoDate][i].charAt(index + 2), 10)] += 1;
      }
    }
  }
  drawHistogram('#tensDigit', tens);
  drawHistogram('#onesDigit', ones);
  drawHistogram('#tenthsDigit', tenths);
  drawHistogram('#hundredthsDigit', hundredths);
}
  </script>
  <style type="text/css" media="screen">
body {
  background-color: white;
  color: black;
}
output {
  display: block;
  height: 600px;
  width: 800px;
}
  </style>
</head>

<body>

<main>
<h1>Charts of Random Numbers Over the Past Month</h1>

<output id="chart"></output>

<h2>By position</h2>

<h3>Tens digit</h3>

<output id="tensDigit"></output>

<h3>Ones digit</h3>

<output id="onesDigit"></output>

<h3>Tenths digit</h3>

<output id="tenthsDigit"></output>

<h3>Hundredths digit</h3>

<output id="hundredthsDigit"></output>
</main>

</body>

</html>
